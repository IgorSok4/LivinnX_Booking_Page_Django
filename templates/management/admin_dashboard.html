{% extends 'admin_base.html' %}
{% load static %}

{% block title %}Admin Dashboard - {{ user.first_name }}{% endblock title %}

{% block content %}
<style>
   a, h5 {
        color: #51ABAC;
    }
    .active {
    color: green;
    }
    .inactive {
        color: red;
    }
</style>
<section style="background: linear-gradient(#ffffff 0%, rgb(184,237,233) 52%, #54fff5 100%);height: 650px; margin-top: 200px;">
    <div class="container">
        <div class="row">
            <div class="col-md-4"><svg xmlns="http://www.w3.org/2000/svg" width="1em" height="1em" fill="currentColor" viewBox="0 0 16 16" class="bi bi-person-fill" style="font-size: 116px;height: 138px;width: 119px;margin-left: 68px;margin-top: 0px;">
                    <path d="M3 14s-1 0-1-1 1-4 6-4 6 3 6 4-1 1-1 1H3zm5-6a3 3 0 1 0 0-6 3 3 0 0 0 0 6z"></path>
                </svg>
                <h3 style="font-family: 'Bebas Neue', serif;">Hello, {{ user.first_name }}</h3>
                <h5><a href="{% url 'profile_edit' %}">Edit your profile</a>.</h5> 
                <h5><a href="{% url "password_change" %}">Change your password</a>.</h5>
            </div>
            <div class="col-md-4">             
                <h3 style="font-family: 'Bebas Neue', serif;">Available Amenities</h3>
                <h5 style="font-family: 'Bebas Neue', serif;">Change the availability of a particular amenity</h5>
                <div class="row">
                    <div class="col-md-6 offset-md-3">
                        <div id="faqlist" class="accordion accordion-flush">
                            {% for amenity in amenities %}
                            <div class="accordion-item">
                                <h2 class="accordion-header">
                                    <button class="btn accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#content-accordion-{{ amenity.slug }}" style="font-family: 'Bebas Neue'">
                                        {{ amenity.slug }} |
                                        {% if amenity.available %}
                                            Active 
                                        {% else %}
                                            Inactive
                                        {% endif %}
                                    </button>
                                </h2>
                                <div id="content-accordion-{{ amenity.slug }}" class="accordion-collapse collapse" data-bs-parent="#faqlist">
                                    <p class="accordion-body">
                                        {% if amenity.available %}
                                            This amenity is currently active.
                                        {% else %}
                                            This amenity is currently inactive.
                                        {% endif %}                                        
                                    </p>
                                    <form method="POST" action="{% url 'admin_amenity_active' amenity_id=amenity.id %}">
                                        {% csrf_token %}
                                        <button class="btn btn-danger deactivate-btn" data-url="{% url 'admin_amenity_active' amenity_id=amenity.id %}" type="submit" value="{% if amenity.available %}Deactivate{% else %}Activate{% endif %}">
                                            {% if amenity.available %}Deactivate{% else %}Activate{% endif %}
                                        </button>
                                    </form>
                                </div>
                            </div>
                            {% endfor %}
                        </div>
                    </div>
                </div>
            </div>
            <div class="col-md-4">             
                <h3 style="font-family: 'Bebas Neue', serif;">Latest reservations</h3>
                <div class="row">
                    <div class="col-md-6 offset-md-3">
                        <div id="faqlist" class="accordion accordion-flush">
                            {% for reservation in latest_reservations %}
                            <div class="accordion-item">
                                <h2 class="accordion-header">
                                    <button class="btn accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#content-accordion-{{ reservation.id }}" style="font-family: 'Bebas Neue'">
                                        {{ reservation.amenity }} | 
                                        {{ reservation.user.first_name }}
                                        {{ reservation.user.last_name }}
                                    </button>
                                </h2>
                                <div id="content-accordion-{{ reservation.id }}" class="accordion-collapse collapse" data-bs-parent="#faqlist">
                                    <p class="accordion-body">
                                        Date: {{ reservation.date|date:"d/m/Y" }}<br>
                                        Status:{% if reservation.active %}
                                            Active<br>
                                        {% else %}
                                            Inactive<br>
                                        {% endif %}
                                        Hours booked:<br>
                                        {% for hour in reservation.hours_booked.all %}
                                            {{ hour }}<br>
                                        {% endfor %}
                                    </p>
                                </div>
                            </div>
                            {% endfor %}
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</section>
{% endblock content %}
{% block extra_js %}
<script>
    {% comment %} console.log({{ user.is_superuser|lower }}); {% endcomment %}
    
    document.querySelectorAll('.deactivate-btn').forEach(btn => {
        btn.addEventListener('click', function (e) {
            e.preventDefault();
            const href = this.getAttribute('data-url');
            const isSuperAdmin = {{ user.is_superuser|lower }};
            const action = this.value.toLowerCase(); // Pobierz wartość atrybutu value
            
            if (!isSuperAdmin) {
                swal("Permission Denied", "You don't have permission to perform this action.", "error");
                return;
            }

            const confirmationText = `You are going to completely ${action} this amenity in the building.\nNo reservations will be possible!\nAre you sure you want to ${action} this amenity?`;
            
            swal({
                title: "Confirmation",
                text: confirmationText,
                icon: "warning",
                buttons: true,
                dangerMode: true,
            })
            .then((willDeactivate) => {
                if (willDeactivate) {
                    fetch(href, {
                        method: 'POST',
                        headers: {
                            'X-CSRFToken': '{{ csrf_token }}'
                        },
                    })
                    .then(res => {
                        if (res.ok) {
                            window.location.reload();
                        } else {
                            swal("Error", "An error occurred while processing your request.", "error");
                        }
                    })
                    .catch(err => console.log(err));
                }
            });
        });
    });
</script>    
   
{% endblock extra_js %}


